From 35a391e9661f1c168ea9febb8b7a3bad5355365f Mon Sep 17 00:00:00 2001
From: Matt Jolly <Matt.Jolly@footclan.ninja>
Date: Thu, 26 Oct 2023 00:54:37 +1000
Subject: [PATCH 1/2] Ensure that /run/fapolicyd exists before performing file
 operations

---
 src/library/database.c | 10 ++++++++--
 src/library/paths.h    |  1 +
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/src/library/database.c b/src/library/database.c
index 5d0624f..4bf9e01 100644
--- a/src/library/database.c
+++ b/src/library/database.c
@@ -116,8 +116,15 @@ int preconstruct_fifo(const conf_t *config)
 	int rc;
 	char err_buff[BUFFER_SIZE];
 
+	/* Ensure that the RUN_DIR exists */
+	if (mkdir(RUN_DIR, 0755) && errno != EEXIST) {
+		msg(LOG_ERR, "Failed to create a directory %s (%s)", RUN_DIR,
+		    strerror_r(errno, err_buff, BUFFER_SIZE));
+		return 1;
+	} else {
 	/* Make sure that there is no such file/fifo */
-	unlink_fifo();
+		unlink_fifo();
+	}
 
 	rc = mkfifo(fifo_path, 0660);
 
@@ -1468,4 +1475,3 @@ void walk_database_finish(void)
 	abort_transaction(lt_txn);
 	close_db(0);
 }
-
diff --git a/src/library/paths.h b/src/library/paths.h
index 37960b3..f066f38 100644
--- a/src/library/paths.h
+++ b/src/library/paths.h
@@ -33,6 +33,7 @@
 #define DB_DIR          "/var/lib/fapolicyd"
 #define DB_NAME         "trust.db"
 #define REPORT          "/var/log/fapolicyd-access.log"
+#define RUN_DIR         "/run/fapolicyd/"
 #define STAT_REPORT     "/run/fapolicyd.state"
 #define fifo_path       "/run/fapolicyd/fapolicyd.fifo"
 #define pidfile         "/run/fapolicyd.pid"
-- 
2.42.0
